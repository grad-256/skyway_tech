name: main

on:
  push:
    branches: [main]
  pull_request: # for dependabot access to secrets
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: ${{ if and(eq(github.event_name, 'pull_request'), eq(github.event.pull_request.user.login, 'dependabot[bot]')) }}writes${{ else }}read${{ endif }}
      id-token: write
      pull-requests: write
      checks: write
      statuses: write

    steps:
      - name: Setup test environment
        run: |
          if [[ "${{ github.event.pull_request.user.login }}" == "dependabot[bot]" ]]; then
            echo "Running Dependabot install without --immutable"
            echo "pnpm install を実行します"
            pnpm install

            # lockfileの変更をコミット
            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'

            if [[ -n $(git status --porcelain package-lock.json) ]]; then
              git add package-lock.json
              git commit -m "chore(deps): update package-lock.json"
              git push origin HEAD:${{ github.head_ref }}
            fi
          else
            echo "Running normal install with --immutable"
            pnpm install --immutable
          fi
          pnpm generate